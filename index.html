const barcodeDatabase = {}; // قاعدة بيانات لمعرفة الباركودات الجديدة
const barcodeTimestamps = {}; // قاعدة بيانات لحفظ وقت قراءة كل باركود
const lastBarcodes = []; // قائمة آخر 5 باركودات

function updateBarcodeList(newBarcode, status) {
    // أضف الباركود إلى القائمة مع الحالة
    lastBarcodes.unshift({ barcode: newBarcode, status });
    if (lastBarcodes.length > 5) {
        lastBarcodes.pop(); // حافظ على آخر 5 باركودات فقط
    }

    // تحديث العرض في واجهة المستخدم
    barcodeListElement.innerHTML = "آخر 5 وصولات:<br>" + lastBarcodes
        .map(item => `<span>${item.status === "✅" ? "جديد" : "مكرر"}:</span> ${item.barcode}`)
        .join("<br>");
}

function scanBarcode() {
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;

    context.clearRect(0, 0, overlay.width, overlay.height);
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const tempContext = canvas.getContext("2d");

    tempContext.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = tempContext.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code) {
        const { topLeftCorner, topRightCorner, bottomRightCorner, bottomLeftCorner } = code.location;

        let frameColor = "red"; // افتراضي مكرر
        let statusIcon = "❌"; // افتراضي خطأ

        if (code.data) {
            const currentTime = Date.now(); // الوقت الحالي بالميلي ثانية

            // تحقق إذا كان الباركود موجودًا وتمت قراءته مؤخرًا
            if (!barcodeDatabase[code.data] || (currentTime - barcodeTimestamps[code.data]) > 1000) {
                frameColor = "green";
                statusIcon = "✅";
                barcodeDatabase[code.data] = true; // اعتبره جديدًا
                barcodeTimestamps[code.data] = currentTime; // حدث زمن القراءة
                output.textContent = `تم اكتشاف باركود جديد: ${code.data}`;
                updateBarcodeList(code.data, "✅");
            } else {
                output.textContent = `تم اكتشاف باركود مكرر: ${code.data}`;
                updateBarcodeList(code.data, "❌");
            }

            if (topLeftCorner && topRightCorner && bottomRightCorner && bottomLeftCorner) {
                context.beginPath();
                context.moveTo(topLeftCorner.x, topLeftCorner.y);
                context.lineTo(topRightCorner.x, topRightCorner.y);
                context.lineTo(bottomRightCorner.x, bottomRightCorner.y);
                context.lineTo(bottomLeftCorner.x, bottomLeftCorner.y);
                context.closePath();
                context.lineWidth = 4;
                context.strokeStyle = frameColor;
                context.stroke();

                const centerX = (topLeftCorner.x + bottomRightCorner.x) / 2;
                const centerY = (topLeftCorner.y + bottomRightCorner.y) / 2;
                context.font = "20px Arial";
                context.fillStyle = frameColor;
                context.textAlign = "center";
                context.fillText(statusIcon, centerX, centerY);
            }
        }
    } else {
        output.textContent = "جاري البحث عن باركود...";
    }

    requestAnimationFrame(scanBarcode);
}
